--   -------------------------------------------------- 
--   Generated by Enterprise Architect Version 7.5.844
--   Created On : Lunes, 19 Diciembre, 2011 
--   DBMS       : PostgreSQL 
--   -------------------------------------------------- 


--  Drop Foreign Key Constraints 
ALTER TABLE auxiliar DROP CONSTRAINT FK_auxiliar_empleado;
ALTER TABLE auxiliar DROP CONSTRAINT FK_auxiliar_estacionprincipal;
ALTER TABLE auxiliar DROP CONSTRAINT FK_auxiliar_operario;
ALTER TABLE bus DROP CONSTRAINT FK_bus_ruta;
ALTER TABLE conductor DROP CONSTRAINT FK_conductor_empleado;
ALTER TABLE conductor_conduce_bus DROP CONSTRAINT FK_conductor_conduce_bus_bus;
ALTER TABLE conductor_conduce_bus DROP CONSTRAINT FK_conductor_conduce_bus_conductor;
ALTER TABLE director DROP CONSTRAINT FK_director_empleado;
ALTER TABLE estacion_paradero DROP CONSTRAINT FK_estacion_paradero_estacion;
ALTER TABLE estacion_principal DROP CONSTRAINT FK_estacion_principal_estacion;
ALTER TABLE estacion_principal DROP CONSTRAINT FK_estacion_principar_operario;
ALTER TABLE medida_reclamo_operario_agrega DROP CONSTRAINT FK_medida_reclamo_operario_agrega_operario;
ALTER TABLE medida_reclamo_operario_agrega DROP CONSTRAINT FK_medida_reclamo_operario_agrega_reclamo;
ALTER TABLE medida_reclamo_operario_agrega DROP CONSTRAINT FK_imedida_reclamo_operario_agrega_medida;
ALTER TABLE operario DROP CONSTRAINT FK_operario_empleado;
ALTER TABLE operario DROP CONSTRAINT FK_operario_director;
ALTER TABLE reclamo_auxiliar_usuario_realiza DROP CONSTRAINT FK_reclamo_auxiliar_usuario_realiza_usuario;
ALTER TABLE reclamo_auxiliar_usuario_realiza DROP CONSTRAINT FK_reclamo_auxiliar_usuario_realiza_medida;
ALTER TABLE reclamo_auxiliar_usuario_realiza DROP CONSTRAINT FK_reclamo_auxiliar_usuario_realiza_auxiliar;
ALTER TABLE ruta_formado_estacion DROP CONSTRAINT FK_ruta_formado_estacion_ruta;
ALTER TABLE ruta_formado_estacion DROP CONSTRAINT FK_rura_formado_estacion_estacion;
ALTER TABLE tarjeta DROP CONSTRAINT FK_tarjeta_auxiliar;
ALTER TABLE tarjeta_generica DROP CONSTRAINT FK_tarjeta_generica_tarjeta;
ALTER TABLE tarjeta_personalizada DROP CONSTRAINT FK_tarjeta_personalizada_tarjeta;
ALTER TABLE tarjeta_uso_ruta DROP CONSTRAINT FK_tarjeta_uso_ruta_ruta;
ALTER TABLE tarjeta_uso_ruta DROP CONSTRAINT FK_tarjeta_uso_ruta_tarjeta;
ALTER TABLE usuario DROP CONSTRAINT FK_usuario_tarjeta;

--  Drop Tables, Stored Procedures and Views 
DROP TABLE IF EXISTS auxiliar;
DROP TABLE IF EXISTS bus;
DROP TABLE IF EXISTS conductor;
DROP TABLE IF EXISTS conductor_conduce_bus;
DROP TABLE IF EXISTS director;
DROP TABLE IF EXISTS empleado;
DROP TABLE IF EXISTS estacion;
DROP SEQUENCE IF EXISTS estacion_id_seq; 

DROP TABLE IF EXISTS estacion_paradero;
DROP TABLE IF EXISTS estacion_principal;
DROP TABLE IF EXISTS medida;
DROP SEQUENCE IF EXISTS medida_id_seq; 

DROP TABLE IF EXISTS medida_reclamo_operario_agrega;
DROP TABLE IF EXISTS operario;
DROP TABLE IF EXISTS reclamo;
DROP SEQUENCE IF EXISTS reclamo_ticket_seq; 

DROP TABLE IF EXISTS reclamo_auxiliar_usuario_realiza;
DROP TABLE IF EXISTS ruta;
DROP TABLE IF EXISTS ruta_formado_estacion;
DROP TABLE IF EXISTS tarjeta;
DROP TABLE IF EXISTS tarjeta_generica;
DROP TABLE IF EXISTS tarjeta_personalizada;
DROP TABLE IF EXISTS tarjeta_uso_ruta;
DROP TABLE IF EXISTS usuario;

--  Create Tables 
CREATE TABLE auxiliar ( 
	id varchar NOT NULL,
	id_jefe varchar,
	trabaja_en varchar
) 
;

CREATE TABLE bus ( 
	matricula varchar(10) NOT NULL,
	tipo varchar(50),
	capacidad integer,
	id_interno varchar(20) NOT NULL,
	ruta_asignada varchar(10),
	estado boolean NOT NULL
);

CREATE TABLE conductor ( 
	id varchar(20) NOT NULL
);

CREATE TABLE conductor_conduce_bus ( 
	id varchar(50) NOT NULL,
	matricula varchar(10) NOT NULL,
	hora_inicio time NOT NULL,
	hora_fin time,
	fecha date NOT NULL
);

CREATE TABLE director ( 
	id varchar(20) NOT NULL
);

CREATE TABLE empleado ( 
	id varchar(20) NOT NULL,
	tipo_id varchar(50),
	fecha_ingreso date,
	salario integer,
	telefono varchar(20),
	direccion varchar(50),
	nombre varchar(50),
	apellido varchar(50),
	fecha_nacimiento date,
	rol integer,
	login varchar(10) NOT NULL,
	password varchar(20) NOT NULL,
	estado boolean NOT NULL
);

CREATE SEQUENCE estacion_id_seq INCREMENT 1 START 1;

CREATE TABLE estacion ( 
	id integer DEFAULT NEXTVAL('estacion_id_seq'::TEXT) NOT NULL,
	ubicacion varchar(100) NOT NULL,
	estado boolean NOT NULL
);

CREATE TABLE estacion_paradero ( 
	id_estacion integer NOT NULL
);

CREATE TABLE estacion_principal ( 
	id_estacion integer NOT NULL,
	nombre varchar(50),
	id_operario varchar(20)
);

CREATE SEQUENCE medida_id_seq INCREMENT 1 START 1;

CREATE TABLE medida ( 
	id integer DEFAULT NEXTVAL('medida_id_seq'::TEXT) NOT NULL,
	accion varchar(200) NOT NULL
);

CREATE TABLE medida_reclamo_operario_agrega ( 
	id_operario varchar(50) NOT NULL,
	ticket integer NOT NULL,
	id_medida integer NOT NULL
);

CREATE TABLE operario ( 
	id varchar(20) NOT NULL,
	id_jefe varchar(20)
);

CREATE SEQUENCE reclamo_ticket_seq INCREMENT 1 START 1;

CREATE TABLE reclamo ( 
	ticket integer DEFAULT NEXTVAL('reclamo_ticket_seq'::TEXT) NOT NULL,
	fecha date,
	descripcion varchar(200),
	motivo varchar(50),
	estado varchar(10)
);

CREATE TABLE reclamo_auxiliar_usuario_realiza ( 
	id_auxiliar varchar(20) NOT NULL,
	id_usuario varchar(20) NOT NULL,
	ticket integer NOT NULL
);

CREATE TABLE ruta ( 
	nombre varchar(10) NOT NULL,
	descripcion varchar(50),
	estado boolean NOT NULL
);

CREATE TABLE ruta_formado_estacion ( 
	nombre varchar(10) NOT NULL,
	id_estacion integer NOT NULL
);

CREATE TABLE tarjeta ( 
	pin varchar(30) NOT NULL,
	saldo integer,
	estado boolean,
	tipo integer,
	vendida_por_auxiliar varchar(20) NOT NULL
);

CREATE TABLE tarjeta_generica ( 
	pin varchar(30) NOT NULL
);

CREATE TABLE tarjeta_personalizada ( 
	pin varchar(30) NOT NULL,
	credito integer
);

CREATE TABLE tarjeta_uso_ruta ( 
	nombre varchar(10) NOT NULL,
	pin varchar(30) NOT NULL,
	fecha date NOT NULL,
	hora time NOT NULL
);

CREATE TABLE usuario ( 
	id varchar(20) NOT NULL,
	tipo_id varchar(5),
	nombre varchar(50),
	apellido varchar(50),
	direccion varchar(50),
	email varchar(50),
	fecha_nacimiento date,
	telefono varchar(10),
	adquiere_tarjeta varchar(30),
	password varchar(20) NOT NULL,
	estado boolean NOT NULL
);


--  Create Primary Key Constraints 
ALTER TABLE auxiliar ADD CONSTRAINT PK_auxiliar 
PRIMARY KEY (id) 
;


ALTER TABLE bus ADD CONSTRAINT PK_bus 
	PRIMARY KEY (matricula);


ALTER TABLE conductor ADD CONSTRAINT PK_conductor 
	PRIMARY KEY (id);


ALTER TABLE conductor_conduce_bus ADD CONSTRAINT PK_conductor_conduce_bus 
	PRIMARY KEY (id, matricula, hora_inicio, fecha);


ALTER TABLE director ADD CONSTRAINT PK_director 
	PRIMARY KEY (id);


ALTER TABLE empleado ADD CONSTRAINT PK_empleado 
	PRIMARY KEY (id);


ALTER TABLE estacion ADD CONSTRAINT PK_estacion 
	PRIMARY KEY (id);


ALTER TABLE estacion_paradero ADD CONSTRAINT PK_paradero 
	PRIMARY KEY (id_estacion);


ALTER TABLE estacion_principal ADD CONSTRAINT PK_principal 
	PRIMARY KEY (id_estacion);


ALTER TABLE medida ADD CONSTRAINT PK_medida 
	PRIMARY KEY (id);


ALTER TABLE medida_reclamo_operario_agrega ADD CONSTRAINT PK_medida_reclamo_operario_agrega 
	PRIMARY KEY (id_operario, ticket, id_medida);


ALTER TABLE operario ADD CONSTRAINT PK_operario 
	PRIMARY KEY (id);


ALTER TABLE reclamo ADD CONSTRAINT PK_reclamo 
	PRIMARY KEY (ticket);


ALTER TABLE reclamo_auxiliar_usuario_realiza ADD CONSTRAINT PK_reclamo_auxiliar_usuario_realiza 
	PRIMARY KEY (id_auxiliar, id_usuario, ticket);


ALTER TABLE ruta ADD CONSTRAINT PK_ruta 
	PRIMARY KEY (nombre);


ALTER TABLE ruta_formado_estacion ADD CONSTRAINT PK_ruta_formado_estacion 
	PRIMARY KEY (nombre, id_estacion);


ALTER TABLE tarjeta ADD CONSTRAINT PK_tarjeta 
	PRIMARY KEY (pin);


ALTER TABLE tarjeta_generica ADD CONSTRAINT PK_tarjeta_generica 
	PRIMARY KEY (pin);


ALTER TABLE tarjeta_personalizada ADD CONSTRAINT PK_tarjeta_personalizada 
	PRIMARY KEY (pin);


ALTER TABLE tarjeta_uso_ruta ADD CONSTRAINT PK_tarjeta_uso_ruta 
	PRIMARY KEY (nombre, pin, fecha, hora);


ALTER TABLE usuario ADD CONSTRAINT PK_usuario 
	PRIMARY KEY (id);



--  Create Indexes 
ALTER TABLE auxiliar
	ADD CONSTRAINT UQ_auxiliar_id UNIQUE (id);
ALTER TABLE bus
	ADD CONSTRAINT UQ_bus_id_interno UNIQUE (id_interno);
ALTER TABLE bus
	ADD CONSTRAINT UQ_bus_matricula UNIQUE (matricula);
ALTER TABLE conductor
	ADD CONSTRAINT UQ_conductor_id UNIQUE (id);
ALTER TABLE director
	ADD CONSTRAINT UQ_director_id UNIQUE (id);
ALTER TABLE empleado
	ADD CONSTRAINT UQ_empleado_id UNIQUE (id);
ALTER TABLE empleado
	ADD CONSTRAINT UQ_empleado_login UNIQUE (login);
ALTER TABLE estacion
	ADD CONSTRAINT UQ_estacion_id UNIQUE (id);
ALTER TABLE estacion
	ADD CONSTRAINT UQ_estacion_ubicacion UNIQUE (ubicacion);
ALTER TABLE estacion_paradero
	ADD CONSTRAINT UQ_estacion_paradero_id_estacion UNIQUE (id_estacion);
ALTER TABLE estacion_principal
	ADD CONSTRAINT UQ_estacion_principal_id_estacion UNIQUE (id_estacion);
ALTER TABLE medida
	ADD CONSTRAINT UQ_medida_accion UNIQUE (accion);
ALTER TABLE medida
	ADD CONSTRAINT UQ_medida_id UNIQUE (id);
ALTER TABLE operario
	ADD CONSTRAINT UQ_operario_id UNIQUE (id);
ALTER TABLE reclamo
	ADD CONSTRAINT UQ_reclamo_ticket UNIQUE (ticket);
ALTER TABLE reclamo_auxiliar_usuario_realiza
	ADD CONSTRAINT UQ_reclamo_auxiliar_usuario_realiza_ticket UNIQUE (ticket);
ALTER TABLE ruta
	ADD CONSTRAINT UQ_ruta_nombre UNIQUE (nombre);
ALTER TABLE tarjeta
	ADD CONSTRAINT UQ_tarjeta_pin UNIQUE (pin);
ALTER TABLE tarjeta_generica
	ADD CONSTRAINT UQ_tarjeta_generica_pin UNIQUE (pin);
ALTER TABLE tarjeta_personalizada
	ADD CONSTRAINT UQ_tarjeta_personalizada_pin UNIQUE (pin);
ALTER TABLE usuario
	ADD CONSTRAINT UQ_usuario_adquiere_tarjeta UNIQUE (adquiere_tarjeta);
ALTER TABLE usuario
	ADD CONSTRAINT UQ_usuario_id UNIQUE (id);

--  Create Foreign Key Constraints

ALTER TABLE auxiliar ADD CONSTRAINT FK_auxiliar_estacionprincipal
	FOREIGN KEY (trabaj_en) REFERENCES estacion_principal (id_estacion);

ALTER TABLE auxiliar ADD CONSTRAINT FK_auxiliar_operario
	FOREIGN KEY (id_jefe) REFERENCES operario (id);
 
ALTER TABLE auxiliar ADD CONSTRAINT FK_auxiliar_empleado 
FOREIGN KEY (id) REFERENCES empleado (id);

ALTER TABLE conductor ADD CONSTRAINT FK_conductor_empleado 
	FOREIGN KEY (id) REFERENCES empleado (id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE conductor_conduce_bus ADD CONSTRAINT FK_conductor_conduce_bus_bus 
	FOREIGN KEY (matricula) REFERENCES bus (matricula)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE conductor_conduce_bus ADD CONSTRAINT FK_conductor_conduce_bus_conductor 
	FOREIGN KEY (id) REFERENCES conductor (id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE director ADD CONSTRAINT FK_director_empleado 
	FOREIGN KEY (id) REFERENCES empleado (id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE estacion_paradero ADD CONSTRAINT FK_estacion_paradero_estacion
	FOREIGN KEY (id_estacion) REFERENCES estacion (id);

ALTER TABLE estacion_principal ADD CONSTRAINT FK_estacion_principal_estacion
	FOREIGN KEY (id_estacion) REFERENCES estacion (id);

ALTER TABLE estacion_principal ADD CONSTRAINT FK_estacion_principar_operario
	FOREIGN KEY (id_operario) REFERENCES operario (id);

ALTER TABLE medida_reclamo_operario_agrega ADD CONSTRAINT FK_imedida_reclamo_operario_agrega_medida
	FOREIGN KEY (id_medida) REFERENCES medida (id);

ALTER TABLE medida_reclamo_operario_agrega ADD CONSTRAINT FK_medida_reclamo_operario_agrega_operario 
	FOREIGN KEY (id_operario) REFERENCES operario (id)
ON DELETE CASCADE;

ALTER TABLE medida_reclamo_operario_agrega ADD CONSTRAINT FK_medida_reclamo_operario_agrega_reclamo 
	FOREIGN KEY (ticket) REFERENCES reclamo (ticket)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE operario ADD CONSTRAINT FK_operario_empleado 
	FOREIGN KEY (id) REFERENCES empleado (id);

ALTER TABLE operario ADD CONSTRAINT FK_operario_director
	FOREIGN KEY (id_jefe) REFERENCES director (id);

ALTER TABLE reclamo_auxiliar_usuario_realiza ADD CONSTRAINT FK_reclamo_auxiliar_usuario_realiza_reclamo
	FOREIGN KEY (ticket) REFERENCES reclamo (ticket);

ALTER TABLE reclamo_auxiliar_usuario_realiza ADD CONSTRAINT FK_reclamo_auxiliar_usuario_realiza_auxiliar
	FOREIGN KEY (id_auxiliar) REFERENCES auxiliar (id);

ALTER TABLE reclamo_auxiliar_usuario_realiza ADD CONSTRAINT FK_reclamo_auxiliar_usuario_realiza_usuario 
	FOREIGN KEY (id_usuario) REFERENCES usuario (id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE ruta_formado_estacion ADD CONSTRAINT FK_rura_formado_estacion_estacion
	FOREIGN KEY (id_estacion) REFERENCES estacion (id);

ALTER TABLE ruta_formado_estacion ADD CONSTRAINT FK_ruta_formado_estacion_ruta 
	FOREIGN KEY (nombre) REFERENCES ruta (nombre)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE tarjeta_generica ADD CONSTRAINT FK_tarjeta_generica_tarjeta 
	FOREIGN KEY (pin) REFERENCES tarjeta (pin)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE tarjeta_personalizada ADD CONSTRAINT FK_tarjeta_personalizada_tarjeta 
	FOREIGN KEY (pin) REFERENCES tarjeta (pin)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE tarjeta_uso_ruta ADD CONSTRAINT FK_tarjeta_uso_ruta_ruta 
	FOREIGN KEY (nombre) REFERENCES ruta (nombre)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE tarjeta_uso_ruta ADD CONSTRAINT FK_tarjeta_uso_ruta_tarjeta 
	FOREIGN KEY (pin) REFERENCES tarjeta (pin)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE bus ADD CONSTRAINT FK_bus_ruta
	FOREIGN KEY (ruta_asignada) REFERENCES ruta (nombre);

ALTER TABLE tarjeta ADD CONSTRAINT FK_tarjeta_auxiliar
	FOREIGN KEY (vendida_por_auxiliar) REFERENCES auxiliar (id);

--ALTER TABLE usuario DROP CONSTRAINT FK_usuario_tarjeta
	FOREIGN KEY (adquiere_tarjeta) REFERENCES tarjeta_personalizada (pin);